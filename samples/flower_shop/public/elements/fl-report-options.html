<link rel="import" href="volatile-storage.html"/>

<polymer-element name="fl-report-options">
  <template>
    <style>
      :host {
        display: block;
        background-color: #EFEFEF;
        padding: 10px;
        font-family: helvita, sans-serif;
      }
      #titleBar > * {
        margin: 0 10px 0 10px;
      }
      h1 {
        font-size: 1.2em;
        padding-left: 15px;
        text-align: left;
      }
      h2 {
        margin: 0;
        font-size: 1em;
        text-align: center;
        border-bottom-style: solid;
        border-bottom-width: 1px;
        border-bottom-color: rgba(0, 0, 0, .3);
      }
      p {
        margin: 0;
      }
      fieldset {
        min-width: 150px;
        border-style: solid;
        border-width: 1px;
        border-color: rgba(0, 0, 0, .3);
        border-radius: 5px;
      }
      #inputs > * {
        margin: 5px;
        padding: 10px;
        min-width: 150px;
        margin: 5px;
        padding: 10px;
      }
      .inputGroup {
        border-style: solid;
        border-width: 1px;
        border-color: rgba(0, 0, 0, .3);
        border-radius: 5px;
      }
      .dateSelector {
        padding: 5px 0 0 0;
      }
      .dateSelector > label {
        min-width: 50px;
      }
      #timeSpanInputs {
        flex: 0 0 auto;
      }
      #refresh > img {
        width: 50px;
        height: 50px;
      }
    </style>

    <div id="titleBar" layout horizontal center>
      <h1>{{label}}</h1>
      <content></content>
    </div>
    <div id="inputs" layout horizontal>
      <div class="inputGroup" id="productSelectionGroup">
        <h2>Products</h2>
        <template repeat="{{ product in salesData.products }}">
          <label><input type="checkbox" name="{{product}}" on-change="{{toggleProduct}}">{{product}}</label><br/>
        </template>
      </div>

      <div id="timeSpanInputs" class="inputGroup">
        <h2>Time Span</h2>
        <div layout horizontal>
          <fieldset flex>
            <legend>
              <label><input id="viewRecent" type="radio" checked="{{viewRecent}}"/>Most Recent</label>
            </legend>
            <select value="{{numberOfDays}}" disabled?="{{!viewRecent}}">
              <option template repeat="{{ i in [1, 2, 3, 4, 5]}}" value="{{i}}">{{i}}</option>
            </select> Days
          </fieldset flex>
          <fieldset>
            <legend>
              <label><input id="viewRange" type="radio" checked="{{viewRange}}"/>Range</label>
            </legend>
            <div class="dateSelector" layout horizontal>
              <label>Start</label>
              <select id="selectStartDate" value="{{startDate}}" on-change="{{updateEndDateOptions}}" disabled?="{{!viewRange}}" flex>
                  <option value="{{date}}" template repeat="{{date in dates}}">{{date}}</option>
              </select><br>
            </div>
            <div class="dateSelector" layout horizontal>
              <label>End</label>
              <select id="selectEndDate" value="{{endDate}}" disabled?="{{!viewRange}}" flex>
                <option value={{date}} template repeat="{{date in endDates}}">{{date}}</option>
              </select><br>
            </div>
          </fieldset>
        </div>
      </div>

      <div class="inputGroup" id="statSelection">
        <h2>View</h2>
        <label><input id="viewSold" type="radio" id="sold" checked="{{viewSold}}"/>Items Sold</label><br/>
        <label><input id="viewUnsold" type="radio" id="unsold" checked="{{viewUnsold}}"/>Items Unsold</label>
      </div>

      <button id="refresh" title="Refresh" on-click={{onRefresh}}><img src="../images/refresh.svg"></img></button>
    </div>
  </template>

  <script>
    Polymer({
      publish: {
        startDate: '',
        endDate: '',
        viewRecent: true,
        numberOfDays: 5,
        viewRange: false,
        viewSold: true,
        viewUnsold: false,
        label: '',
        localStorageKey: '',

        // Use this to set ALL options as a json string
        options: ''
      },
      ready: function () {
        this.storage = document.getElementById('storage');

        this.salesData = window.salesData;

        this.dates = _.uniq(_.pluck(this.salesData.history, "date")).sort(function (date1, date2) {
          return Date.parse(date1) - Date.parse(date2);
        });
        this.endDates = this.dates;

        if (this.options) {
          if (typeof this.options == 'string' || this.options instanceof String) {
            Polymer.extend(this, JSON.parse(this.options));
          } else {
            Polymer.extend(this, this.options);
          }
        } else if (!this.localStorageKey ||
                   !this.localStorageKey.length > 0 ||
                   !this.loadSavedState()) {
          this.startDate = this.dates[0];
          this.endDate = this.dates[this.dates.length - 1];
          this.includedProducts = [];
          this.salesData.products.forEach(function (product) {
            this.includedProducts.push(product);
          }.bind(this));
        }

        mutualExclusion(this, ['viewRange', 'viewRecent']);
        mutualExclusion(this, ['viewSold', 'viewUnsold']);
      },
      domReady: function () {
        var productSelectors = this.$.productSelectionGroup.querySelectorAll('input[type=checkbox]');
        for (var i = 0; i < productSelectors.length; i++) {
          if (this.includedProducts.indexOf(productSelectors[i].name) != -1){
              productSelectors[i].setAttribute('checked', 'checked');
          }
        }
      },
      loadSavedState: function () {
        var state = this.storage.getItem(this.localStorageKey);
        if (!state) return false;
        Polymer.extend(this, JSON.parse(state));
        return true;
      },
      saveState: function () {
        if (this.localStorageKey && this.localStorageKey.length > 0) {
          this.storage.setItem(this.localStorageKey, JSON.stringify(this.getState()));
        }
      },
      getState: function () {
        return {
          startDate: this.startDate,
          endDate: this.endDate,
          numberOfDays: this.numberOfDays,
          viewSold: this.viewSold,
          viewUnsold: this.viewUnsold,
          viewRecent: this.viewRecent,
          viewRange: this.viewRange,
          includedProducts: this.includedProducts
        }
      },
      updateEndDateOptions: function (event) {
        this.endDates = this.dates.filter(function (date) {
          return Date.parse(date) >= Date.parse(event.target.value);
        }.bind(this));
        if (Date.parse(this.endDate) < Date.parse(event.target.value)){
          this.endDate = event.target.value;
        }
      },
      toggleProduct: function (event) {
        if (event.target.checked) {
          this.includedProducts.push(event.target.name);
        } else {
          this.includedProducts = this.includedProducts.filter(function (el) {
            return el != event.target.name;
          });
        }
      },
      selectStat: function (event) {
        if (event.target.id == 'viewSold') {
          this.viewSold = true;
          this.viewUnsold = false;
        } else {
          this.viewSold = false;
          this.viewUnsold = true;
        }
      },
      getTimeSpan: function () {
        var timeSpan = {};

        if (this.viewRecent) {
          timeSpan.startDate = this.dates[this.dates.length - this.numberOfDays];
          timeSpan.endDate = this.dates[this.dates.length - 1];
        } else {
          timeSpan.startDate = this.startDate;
          timeSpan.endDate = this.endDate;
        }

        return timeSpan;
      },
      onRefresh: function () {
        this.saveState();
        setTimeout(function () {
          this.fire('refresh', {});
        }.bind(this), 0);
      }
    });
  </script>
</polymer-element>
