<link rel="import" href="fl-report-options.html"/>
<link rel="import" href="../bower_components/google-chart/google-chart.html"/>
<link rel="import" href="../bower_components/core-ajax/core-ajax.html"/>

<polymer-element name="fl-sales-distribution">
  <template>
    <style>
      :host {
        display: block;
      }
      :host > div[layout] {
        height: 100%;
      }
      content {
        flex: 0 0 auto;
      }
    </style>
    <core-ajax auto id="ajax" handleAs="json" on-core-response="{{onNewData}}"></core-ajax>
    <div layout vertical center>
      <content></content>
      <div layout horizontal start>
        <google-chart id="pieChart" type='pie'></google-chart>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      domReady: function (event) {
        this.storage = document.getElementById('storage');
        this.$.options = this.querySelector('#options');
        this.$.options.addEventListener('refresh', this.refresh.bind(this));

        this.refresh();
      },
      refresh: function () {
        this.getChartData();
        this.redraw();
      },
      getChartData: function () {
        this.chartData = {};

        var timeSpan = this.$.options.getTimeSpan();

        window.salesData.history.forEach(function (report){
          // Check that this product is selected for the report
          if (this.$.options.includedProducts.indexOf(report.flower) == -1) return;
          if (Date.parse(report.date) < Date.parse(timeSpan.startDate)) return;
          if (Date.parse(report.date) > Date.parse(timeSpan.endDate)) return;

          // Init the total for this product if not yet done
          this.chartData[report.flower] = this.chartData[report.flower] || {
            total: 0,
          };

          // Accumulate the total for the requested data
          if (this.$.options.viewSold) {
            this.chartData[report.flower].total += parseInt(report['quantity-sold']);
          } else {
            this.chartData[report.flower].total += parseInt(report['quantity-unsold']);
          }
        }.bind(this));
        return this.chartData;
      },
      redraw: function () {
        var cols = [{label: 'Flower', type: 'string'}, {label: 'Total Sales', type: 'number'}];
        var rows = [];

        Object.keys(this.chartData).map(function (product) {
          rows.push([product, this.chartData[product].total]);
        }.bind(this));

        this.$.pieChart.options.legend = {};
        this.$.pieChart.options.legend.position = 'bottom';
        this.$.pieChart.options.pieHole = 0.4;
        this.$.pieChart.cols = cols;
        this.$.pieChart.rows = rows;

        this.$.pieChart.drawChart();
      }
    });
  </script>
</polymer-element>
