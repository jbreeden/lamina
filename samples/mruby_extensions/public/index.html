<!DOCTYPE html>
<html>
<header>
  <title>MRuby + JavaScript Interop Tests</title>
  <style>
    table {
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid black;
    }
    td {
      padding: 5px;
    }
  </style>
</header>
<body>

<!-- Creating JavaScript objects from Ruby -->

<template class="ruby-test">
V8.create_undefined
</template>
<template class="ruby-test">
V8.create_null
</template>
<template class="ruby-test">
V8.create_bool true
</template>
<template class="ruby-test">
V8.create_bool false
</template>
<template class="ruby-test">
V8.create_bool 1
</template>
<template class="ruby-test">
V8.create_bool nil
</template>
<template class="ruby-test">
V8.create_int 3
</template>
<template class="ruby-test">
V8.create_float 4.5
</template>
<template class="ruby-test">
V8.create_string 'Hello, from mruby!'
</template>
<template class="ruby-test">
obj = V8.create_object
obj[:myRubyClass] = V8.create_string(obj.class.to_s)
V8.window[:JSON][:stringify].apply(V8.window[:JSON], [obj])
</template>

<!-- Checking the type of JavaScript objects from Ruby -->

<template class="ruby-test">
# `type_of` shows how you'd check the type of JavaScript objects in Ruby
# TODO: Consider making this a method on Cef::V8::JsObject class
V8.window[:type_of] = V8.create_function 'type_of' do |args|
  arg = args[:shift].apply(args, [])
  if arg.is_undefined
    V8.create_string 'undefined'
  elsif arg.is_null
    V8.create_string 'null'
  elsif arg.is_bool
    V8.create_string 'bool'
  elsif arg.is_int
    V8.create_string 'int'
  elsif arg.is_uint
    V8.create_string 'uint'
  elsif arg.is_double
    V8.create_string 'double'
  elsif arg.is_date
    V8.create_string 'date'
  elsif arg.is_string
    V8.create_string 'string'
  elsif arg.is_array
    V8.create_string 'array'
  elsif arg.is_function
    V8.create_string 'function'
  elsif arg.is_object
    V8.create_string 'object'
  end
end

V8.exec "window.val = undefined"
V8.window[:type_of].apply(V8.window, [V8.window[:val]])
</template>
<template class="ruby-test">
V8.exec "window.val = null"
V8.window[:type_of].apply(V8.window, [V8.window[:val]])
</template>
<template class="ruby-test">
V8.exec "window.val = true"
V8.window[:type_of].apply(V8.window, [V8.window[:val]])
</template>
<template class="ruby-test">
V8.exec "window.val = false"
V8.window[:type_of].apply(V8.window, [V8.window[:val]])
</template>
<template class="ruby-test">
V8.exec "window.val = 1"
V8.window[:type_of].apply(V8.window, [V8.window[:val]])
</template>
<template class="ruby-test">
V8.exec "window.val = 1.5"
V8.window[:type_of].apply(V8.window, [V8.window[:val]])
</template>
<template class="ruby-test">
V8.exec "window.val = new Date()"
V8.window[:type_of].apply(V8.window, [V8.window[:val]])
</template>
<template class="ruby-test">
V8.exec "window.val = 'test'"
V8.window[:type_of].apply(V8.window, [V8.window[:val]])
</template>
<template class="ruby-test">
V8.exec "window.val = []"
V8.window[:type_of].apply(V8.window, [V8.window[:val]])
</template>
<template class="ruby-test">
V8.exec "window.val = function () {}"
V8.window[:type_of].apply(V8.window, [V8.window[:val]])
</template>
<template class="ruby-test">
V8.exec "window.val = {}"
V8.window[:type_of].apply(V8.window, [V8.window[:val]])
</template>

<!-- Reading primitive values from JavaScript objects in Ruby -->

<template class="ruby-test">
V8.exec "window.val = true"
V8.create_string V8.window[:val].bool_value.to_s
</template>
<template class="ruby-test">
V8.exec "window.val = false"
V8.create_string V8.window[:val].bool_value.to_s
</template>
<template class="ruby-test">
V8.exec "window.val = 1"
V8.create_string V8.window[:val].int_value.to_s
</template>
<template class="ruby-test">
V8.exec "window.val = 1.5"
V8.create_string V8.window[:val].double_value.to_s
</template>
<template class="ruby-test">
V8.exec "window.val = 'test'"
V8.create_string V8.window[:val].string_value
</template>

<!-- V8.exec -->

<template class="ruby-test">
V8.exec "window.execedString = 'String created by V8.exec'"
V8.window[:execedString]
</template>

<!-- Exposing Ruby functions to JavaScript -->

<template class="ruby-test">
V8.window[:ls] = V8.create_function "ls" do |args|
  result = ""
  Dir.entries('.').each do |e|
    result += " #{e} "
  end
  V8.create_string result
end
</template>
<template class="ruby-test">
V8.window[:strip] = V8.create_function 'strip' do |args|
  arg = args[:shift].apply(args, [])
  V8.create_string arg.string_value.strip
end

V8.window[:call_strip] = V8.create_function 'call_strip' do |args|
  V8.window[:strip].apply(V8.window, [V8.create_string('       Strip my whitespace, please!          ')])
end
</template>

<template class="ruby-test">
V8.window[:raise] = V8.create_function 'raise' do |args|
  raise 'my error'
end
</template>

<div>
  <table id="table">
    <thead>
      <th>Code</th><th>Result</th>
    </thead>
  </table>
</div>
<script>
  function test(code) {
    var result = ruby(code);
    if (typeof result == 'function') {
      try {
        result = result();
      } catch (e) {
        result = e;
      }
    }

    window.table.innerHTML = window.table.innerHTML +
      "<tr><td><pre><code>" + code + "</code></pre></td><td>" + result + "</td></tr>"
  }

  var tests = Array.prototype.slice.call(document.querySelectorAll(".ruby-test"));
  tests.forEach(function(testCase){
    // \s\S is a hack to match any character (. does not match newlines)
    var stripped = testCase.innerHTML.match(/([^\s][\s\S]*[^\s])/mi)[1];
    test(stripped);
  });
</script>
</body>
</html>
